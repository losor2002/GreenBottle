<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="it">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/>
    <link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/>
    <title>AccettazioneOrdineAdminTest.java</title>
    <link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/>
    <script type="text/javascript" src="../jacoco-resources/prettify.js"></script>
</head>
<body onload="window['PR_TAB_WIDTH']=4;prettyPrint()">
<div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html"
                                                              class="el_session">Sessions</a></span><a
        href="../index.html" class="el_report">All in greenbottle Coverage Results</a> &gt; <a href="index.source.html"
                                                                                               class="el_package">it.unisa.greenbottle.ordineTest</a>
    &gt; <span class="el_source">AccettazioneOrdineAdminTest.java</span></div>
<h1>AccettazioneOrdineAdminTest.java</h1>
<pre class="source lang-java linenums">package it.unisa.greenbottle.ordineTest;

import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.when;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

import it.unisa.greenbottle.controller.accessoControl.util.SessionAdmin;
import it.unisa.greenbottle.storage.accessoStorage.entity.Admin;
import it.unisa.greenbottle.storage.accessoStorage.entity.Cliente;
import it.unisa.greenbottle.storage.ordineStorage.dao.OrdineDao;
import it.unisa.greenbottle.storage.ordineStorage.entity.Ordine;
import java.sql.Timestamp;
import java.util.Optional;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.bean.override.mockito.MockitoBean;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.ResultMatcher;

/**
 * Testa la funzionalit√† di accettazione di un ordine da parte dell'admin.
 */
@SpringBootTest
@AutoConfigureMockMvc
<span class="fc" id="L29">public class AccettazioneOrdineAdminTest {</span>
  @Autowired
  private MockMvc mockMvc;

  @MockitoBean
  private SessionAdmin sessionAdmin;

  @MockitoBean
  private OrdineDao ordineDao;

  @Test
  public void idNonValido() throws Exception {
<span class="fc" id="L41">    test(-1L, status().isBadRequest(), &quot;Id non valido.&quot;);</span>
<span class="fc" id="L42">  }</span>

  @Test
  public void idNonPresente() throws Exception {
<span class="fc" id="L46">    Cliente cliente = new Cliente();</span>
<span class="fc" id="L47">    final String testId = &quot;999&quot;;</span>
<span class="fc" id="L48">    Ordine ordine =</span>
        new Ordine(12f, Ordine.StatoSpedizione.ELABORAZIONE, false, &quot;0000-0000-0000-0000&quot;,
<span class="fc"
      id="L50">            false, &quot;&quot;, new Timestamp(System.currentTimeMillis()), cliente, null);</span>
<span class="fc" id="L51">    ordine.setId(1L);</span>
<span class="fc" id="L52">    ordineDao.save(ordine);</span>

<span class="fc" id="L54">    Admin admin = new Admin();</span>
<span class="fc" id="L55">    when(ordineDao.findOrdineById(1L)).thenReturn(Optional.of(ordine));</span>
<span class="fc" id="L56">    when(sessionAdmin.getAdmin()).thenReturn(Optional.of(admin));</span>

<span class="fc" id="L58">    mockMvc.perform(post(&quot;/admin/accettazioneOrdine&quot;).param(&quot;ordineId&quot;, testId)</span>
<span class="fc" id="L59">            .param(&quot;newState&quot;, Ordine.StatoSpedizione.ACCETTATO.toString()))</span>
<span class="fc" id="L60">        .andExpect(status().isNotFound())</span>
<span class="fc" id="L61">        .andExpect(result -&gt; {</span>
<span class="fc" id="L62">          String errorMessage = result.getResponse().getErrorMessage();</span>
<span class="pc bpc" id="L63" title="1 of 2 branches missed.">          if (errorMessage != null) {</span>
<span class="nc" id="L64">            assertTrue(errorMessage.contains(&quot;Ordine non presente.&quot;),</span>
                &quot;La risposta non contiene il messaggio atteso: Ordine non presente.&quot;);
          }
<span class="fc" id="L67">        });</span>
<span class="fc" id="L68">  }</span>

  @Test
  public void idValido() throws Exception {
<span class="fc" id="L72">    test(1L, status().isOk(), null);</span>
<span class="fc" id="L73">  }</span>

  private void test(Long idOrdine, ResultMatcher resultMatcher, String expectedMessage)
      throws Exception {
<span class="fc" id="L77">    Admin admin = new Admin();</span>
<span class="fc" id="L78">    Cliente cliente = new Cliente();</span>
<span class="fc" id="L79">    Ordine ordine =</span>
        new Ordine(12f, Ordine.StatoSpedizione.ELABORAZIONE, false, &quot;0000-0000-0000-0000&quot;,
<span class="fc"
      id="L81">            false, &quot;&quot;, new Timestamp(System.currentTimeMillis()), cliente, null);</span>
<span class="fc" id="L82">    ordine.setId(1L);</span>

<span class="fc" id="L84">    when(ordineDao.findOrdineById(any())).thenReturn(Optional.of(ordine));</span>
<span class="fc" id="L85">    when(sessionAdmin.getAdmin()).thenReturn(Optional.of(admin));</span>

<span class="fc" id="L87">    mockMvc.perform(post(&quot;/admin/accettazioneOrdine&quot;)</span>
<span class="fc" id="L88">            .param(&quot;ordineId&quot;, idOrdine.toString())</span>
<span class="fc" id="L89">            .param(&quot;newState&quot;, Ordine.StatoSpedizione.ACCETTATO.toString()))</span>
<span class="fc" id="L90">        .andExpect(resultMatcher)</span>
<span class="fc" id="L91">        .andExpect(result -&gt; {</span>
<span class="fc bfc" id="L92" title="All 2 branches covered.">          if (expectedMessage != null) {</span>
<span class="fc" id="L93">            String errorMessage = result.getResponse().getContentAsString();</span>
<span class="fc" id="L94">            assertTrue(errorMessage.contains(expectedMessage),</span>
                &quot;La risposta non contiene il messaggio atteso: &quot; + expectedMessage);
          }
<span class="fc" id="L97">        });</span>
<span class="fc" id="L98">  }</span>
}
</pre>
<div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span>
</div>
</body>
</html>